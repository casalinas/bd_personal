

VAR b_carga_familiar number;
EXEC :b_carga_familiar := 6300; 

VAR b_mes_fecha_proceso_calcular number;
EXEC :b_mes_fecha_proceso_calcular := 5;

VAR b_anno_fecha_proceso_calcular number;
EXEC :b_anno_fecha_proceso_calcular := 2021;

VAR b_fecha_proceso number;

VAR b_porcentaje number;

VAR b_bonif_antig_tramo_1 number ;
EXEC :b_bonif_antig_tramo_1 := 0.04

VAR b_bonif_antig_tramo_2 number;
EXEC :b_bonif_antig_tramo_2 := 0.06

VAR b_bonif_antig_tramo_3 number;
EXEC :b_bonif_antig_tramo_3 := 0.07

VAR b_bonif_antig_tramo_4 number; 
EXEC :b_bonif_antig_tramo_4 :=0.1

VAR b_bonif_antig_tramo_5 number;
EXEC :b_bonif_antig_tramo_5 := 0.15

VAR b_bonif_antig_tramo_6 number;
EXEC :b_bonif_antig_tramo_6 := 0.18

VAR b_bono_grupos_A number;
EXEC :b_bono_grupos_A := 0.35;

VAR b_bono_grupos_B number;
EXEC :b_bono_grupos_B := 0.30;

VAR b_bono_grupos_C number;
EXEC :b_bono_grupos_C := 0.25;

VAR b_bono_grupos_D number;
EXEC :b_bono_grupos_D := 0.20;

VAR b_bono_sin_grupo number;
EXEC :b_bono_sin_grupo := 0;

truncate table haber_mes_vendedor;
truncate table descuento_mes_vendedor;

DECLARE 
v_id_vendedor number; v_numrut_vendedor number; v_mes_proceso number;
v_anno_proceso number; v_sueldo_base number;

v_asig_antiguedad number; v_annos_antiguedad number;

v_n_cargas_familiares number;
v_asig_cargas number; v_id_carga number;

v_comisiones number;
-- para hacer d.
v_bono_categ number;
v_total_ventas_mes number;
v_porcentaje number;
v_id_cat char(1);

-- para hacer e
v_id_grupo_vr varchar2(1);
v_bono_grupos_porc number;
v_bono_grupos number;

-- para f.
v_descuentos number;
v_ant_mes number;

v_total_haberes number;

v_valor_afp number;
v_valor_salud number;
v_porc_desc_afp number;
v_porc_desc_salud number;


BEGIN
for i in (
select 
vr.id_vendedor id,
vr.rut_vendedor,
EXTRACT(MONTH FROM vt.fecha_venta) MES,
EXTRACT(YEAR FROM vt.fecha_venta) ANNO,
vr.sueldo,
ROUND(MONTHS_BETWEEN(SYSDATE,vr.FECCONTRATO)/12) antiguedad,
COUNT( DISTINCT CARGA.NUMRUT_CARGA) cuenta,
com.monto_comision comision,
com.mes mes_com,
com.total_ventas total_v_mes,
cat.porcentaje porc_venta,
vr.id_categoria id_categoria,
vr.id_grupo id_grupo,

ant.monto monto_anticipo,
ant.mes ant_mes,

afp.porc_descto_afp desc_afp,
sal.porc_descto_salud desc_salud
 

from venta vt 
RIGHT join vendedor vr on (vt.id_vendedor = vr.id_vendedor)
left join carga_familiar carga 
on (carga.id_vendedor = vr.id_vendedor)
join comision_venta com on (com.id_vendedor = vr.id_vendedor)
left JOIN categoria cat on (vr.id_categoria = cat.id_categoria)
JOIN anticipo ant ON (vr.id_vendedor = ant.id_vendedor)
JOIN afp afp on (afp.id_afp = vr.id_afp)
JOIN SALUD sal on (sal.id_salud = vr.id_salud)
WHERE EXTRACT(MONTH FROM vt.fecha_venta) = :b_mes_fecha_proceso_calcular
AND EXTRACT(YEAR FROM vt.fecha_venta) = :b_anno_fecha_proceso_calcular
AND com.mes = 5
AND ant.mes = com.mes -1

GROUP BY 
vr.id_vendedor,
vr.rut_vendedor,
EXTRACT(MONTH FROM vt.fecha_venta),
EXTRACT(YEAR FROM vt.fecha_venta),
vr.sueldo,
ROUND(MONTHS_BETWEEN(SYSDATE,vr.FECCONTRATO)/12),
com.monto_comision,
com.mes,
com.total_ventas,
cat.porcentaje,
vr.id_categoria,
vr.id_grupo,
ant.monto,
ant.mes,
afp.porc_descto_afp,
sal.porc_descto_salud
)

----------------------------------------------------------------------

LOOP

v_numrut_vendedor := i.rut_vendedor;
v_mes_proceso := i.mes;
v_anno_proceso := i.anno;
v_sueldo_base := i.sueldo;
v_annos_antiguedad := i.antiguedad;

v_total_ventas_mes := i.total_v_mes;
v_porcentaje := i.porc_venta;
v_id_cat := i.id_categoria;

v_id_grupo_vr:= i.id_grupo;

v_porc_desc_afp := i.desc_afp;
v_porc_desc_salud := i.desc_salud;
dbms_output.put_line(v_VALOR_afp||' '||v_valor_salud);

----------------------------------------------------------------------
--v_ant_mes := i.ant_mes;

--dbms_output.put_line('el vendedor '||v_id_vendedor||' tiene '||v_n_cargas_familiares|| ' CARGAS Familiares ');
-- a. calculo por asignacion de antiguedad
v_asig_antiguedad :=  
    CASE    
    WHEN  v_annos_antiguedad BETWEEN 1 AND 9 THEN  ROUND(v_sueldo_base * :b_bonif_antig_tramo_1)
    WHEN  v_annos_antiguedad BETWEEN 10 AND 12 THEN ROUND(v_sueldo_base * :b_bonif_antig_tramo_2)
    WHEN  v_annos_antiguedad BETWEEN 13 AND 16 THEN ROUND(v_sueldo_base * :b_bonif_antig_tramo_3)
    WHEN  v_annos_antiguedad BETWEEN 17 AND 30 THEN ROUND(v_sueldo_base * :b_bonif_antig_tramo_4)
    WHEN  v_annos_antiguedad BETWEEN 31 AND 40 THEN ROUND(v_sueldo_base * :b_bonif_antig_tramo_5)
    WHEN  v_annos_antiguedad BETWEEN 41 AND 50 THEN ROUND(v_sueldo_base * :b_bonif_antig_tramo_6)
    ELSE 0
    END;
    COMMIT;

-- b. Valor de asignaci칩n carga familiar
v_n_cargas_familiares := i.cuenta;
v_id_vendedor  := i.id;
--dbms_output.put_line('el vendedor '||v_id_vendedor||' tiene '||v_n_cargas_familiares|| ' CARGAS Familiares ');    
    
    v_asig_cargas := ROUND(v_n_cargas_familiares * :b_carga_familiar);
      
      
-- c. comisi칩n a침adida
v_comisiones := i.comision;
--dbms_output.put_line('la comision del empleado ' || v_id_vendedor||' es de '|| v_comisiones);      

-- d. Calculando el bono por categoria de vendedor

  v_bono_categ := ROUND(v_total_ventas_mes * (v_porcentaje/100));
  
  
  
-- dbms_output.put_line(v_id_vendedor ||' '||v_id_cat||' '||'tiene un '||v_porcentaje||' de bono');      

-- dbms_output.put_line(' el total de ventas ' || v_total_ventas_mes ||' ' ||v_id_vendedor ||' '||v_id_cat||' '||'tiene un '||v_porcentaje||' de bono, equivalente a '||v_bono_categ);      

-- e. calculo de asignaci칩n especial por grupo al que pertenecen los vendedores (id_grupo) 
    
-- v_id_grupo_vr    
-- :b_bono_grupos_A
-- v_bono_grupos
     

    IF v_id_grupo_vr like 'A%' AND v_total_ventas_mes > 5500000 THEN v_bono_grupos := ROUND(v_sueldo_base * :b_bono_grupos_A);
    ELSIF v_id_grupo_vr like 'B%' AND v_total_ventas_mes > 5500000 THEN v_bono_grupos :=  ROUND(v_sueldo_base * :b_bono_grupos_B);
    ELSIF v_id_grupo_vr like 'C%' AND v_total_ventas_mes > 5500000 THEN v_bono_grupos :=  ROUND(v_sueldo_base * :b_bono_grupos_C);
    ELSIF v_id_grupo_vr like 'D%' AND v_total_ventas_mes > 5500000 THEN v_bono_grupos :=  ROUND(v_sueldo_base * :b_bono_grupos_D);
    ELSIF v_id_grupo_vr IS NULL THEN v_bono_grupos := :b_bono_sin_grupo;
    ELSE v_bono_grupos := 0;
    END IF;
    
--   -- dbms_output.put_line(v_bono_grupos); 

  -- f. descuentos vendedor (columna descuentos habermesvendedor)  
  
  v_descuentos := i.monto_anticipo;
  v_ant_mes := i.ant_mes;

 -- dbms_output.put_line(v_descuentos||' '||v_ant_mes); 
 -- g. TOTAL HABERES 
 
 v_total_haberes := v_sueldo_base + v_asig_antiguedad + v_asig_cargas + v_comisiones+ v_bono_categ + v_bono_grupos - v_descuentos; 

-- h. Descuentos por AFP Y SALUD
--v_desc_afp ;
--v_desc_salud ;

v_valor_afp := ROUND(v_total_haberes * (v_porc_desc_afp/100));
v_valor_salud := ROUND( v_total_haberes * (v_porc_desc_salud/100));

INSERT INTO descuento_mes_vendedor VALUES (
v_id_vendedor,
v_numrut_vendedor,
v_mes_proceso,
v_anno_proceso,
v_valor_salud,
v_valor_afp);


INSERT INTO haber_mes_vendedor VALUES (
v_id_vendedor,
v_numrut_vendedor,
v_mes_proceso,
v_anno_proceso,
v_sueldo_base,
v_asig_antiguedad,
v_asig_cargas,
v_comisiones,
v_bono_categ,
v_bono_grupos,
v_descuentos,
v_total_haberes);


END LOOP;
end;
/
/*
SELECT COUNT(*),id_vendedor FROM carga_familiar
GROUP BY id_vendedor;
*/
-- truncate table haber_mes_vendedor;
-- truncate table descuento_mes_vendedor;
/*
SELECT * FROM AFP;
SELECT * FROM SALUD;
*/