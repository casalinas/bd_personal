VAR b_carga_familiar number;
EXEC :b_carga_familiar := 6300; 
DECLARE 
v_id_vendedor number; v_numrut_vendedor number; v_mes_proceso number;
v_anno_proceso number; v_sueldo_base number;

v_asig_antiguedad number; v_annos_antiguedad number;

v_n_cargas_familiares number;
v_asig_cargas number; v_id_carga number;

v_comisiones number; v_bono_categ number;
v_bono_grupos number; v_descuentos number;
v_total_haberes number;


BEGIN
for i in (
select 
vr.id_vendedor id,
vr.rut_vendedor,
EXTRACT(MONTH FROM vt.fecha_venta) MES,
EXTRACT(YEAR FROM vt.fecha_venta) ANNO,
vr.sueldo,
ROUND(MONTHS_BETWEEN(SYSDATE,vr.FECCONTRATO)/12) antiguedad,
COUNT( DISTINCT CARGA.NUMRUT_CARGA) cuenta,
com.monto_comision comision,
com.mes mes_com
 

from venta vt 
RIGHT join vendedor vr on (vt.id_vendedor = vr.id_vendedor)
left join carga_familiar carga 
on (carga.id_vendedor = vr.id_vendedor)
join comision_venta com on (com.id_vendedor = vr.id_vendedor)
WHERE EXTRACT(MONTH FROM vt.fecha_venta) = 05
AND EXTRACT(YEAR FROM vt.fecha_venta) = 2021
AND com.mes = 5

GROUP BY 
vr.id_vendedor,
vr.rut_vendedor,
EXTRACT(MONTH FROM vt.fecha_venta),
EXTRACT(YEAR FROM vt.fecha_venta),
vr.sueldo,
ROUND(MONTHS_BETWEEN(SYSDATE,vr.FECCONTRATO)/12),
com.monto_comision,
com.mes
)

LOOP

v_numrut_vendedor := i.rut_vendedor;
v_mes_proceso := i.mes;
v_anno_proceso := i.anno;
v_sueldo_base := i.sueldo;
v_annos_antiguedad := i.antiguedad;

--dbms_output.put_line('el vendedor '||v_id_vendedor||' tiene '||v_n_cargas_familiares|| ' CARGAS Familiares ');
-- a. calculo por asignacion de antiguedad
v_asig_antiguedad :=  
    CASE    
    WHEN  v_annos_antiguedad BETWEEN 1 AND 9 THEN  ROUND(v_sueldo_base * 0.04)
    WHEN  v_annos_antiguedad BETWEEN 10 AND 12 THEN ROUND(v_sueldo_base * 0.06)
    WHEN  v_annos_antiguedad BETWEEN 13 AND 16 THEN ROUND(v_sueldo_base * 0.07)
    WHEN  v_annos_antiguedad BETWEEN 17 AND 30 THEN ROUND(v_sueldo_base * 0.1)
    WHEN  v_annos_antiguedad BETWEEN 31 AND 40 THEN ROUND(v_sueldo_base * 0.15)
    WHEN  v_annos_antiguedad BETWEEN 41 AND 50 THEN ROUND(v_sueldo_base * 0.18)
    ELSE 0
    END;
    COMMIT;

-- b. Valor de asignación carga familiar
v_n_cargas_familiares := i.cuenta;
v_id_vendedor := i.id;
--dbms_output.put_line('el vendedor '||v_id_vendedor||' tiene '||v_n_cargas_familiares|| ' CARGAS Familiares ');    
    
    v_asig_cargas := ROUND(v_n_cargas_familiares * :b_carga_familiar);
      
      
-- c. comisión añadida
v_comisiones := i.comision;
dbms_output.put_line('la comision del empleado ' || v_id_vendedor||' es de '|| v_comisiones);      

      
      
/*
       INSERT INTO haber_mes_vendedor VALUES 
  (v_id_vendedor,v_numrut_vendedor,v_mes_proceso,
  v_anno_proceso,
  v_sueldo_base,
  v_asig_antiguedad,
  v_asig_cargas,
  v_comisiones,1,1,1,1);
*/

END LOOP;
end;
/
/*
SELECT COUNT(*),id_vendedor FROM carga_familiar
GROUP BY id_vendedor;
*/
-- truncate table haber_mes_vendedor;
/*
select cat.id_categoria,vr.id_grupo,vr.id_vendedor, cat.porcentaje from categoria cat
join vendedor vr on (vr.id_categoria = cat.id_categoria)
join comision_venta cv on (cv.id_vendedor = vr.id_vendedor);
*/